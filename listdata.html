<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>List Data Peminjaman</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f2f2f2; }
    h2 { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #e0e0e0; }
    .details { display: none; margin-top: 10px; margin-bottom: 10px; }
    .owner-only { color: red; cursor: pointer; }
    .btn { padding: 4px 8px; margin-right: 5px; cursor: pointer; border: none; border-radius: 4px; }
    .btn-danger { background: red; color: white; }
    .btn-acc { background: green; color: white; }
    .btn-tolak { background: #555; color: white; }
    .filters input, .filters select { padding: 5px; margin-right: 10px; }
    .row-error { background-color: #ffe6e6 !important; }
  </style>
</head>
<body>

<h2>Daftar Data Peminjaman</h2>

<div class="filters">
  <input type="text" id="filterAdmin" placeholder="Filter Admin...">
  <input type="date" id="filterTanggal">
  <select id="filterStatus">
    <option value="">Semua Status</option>
    <option value="Belum ACC">Belum ACC</option>
    <option value="ACC">ACC</option>
    <option value="Ditolak">Ditolak</option>
  </select>
  <button onclick="applyFilters()">Terapkan Filter</button>
</div>

<h3>Total Modal Keluar:</h3>
<ul>
  <li><strong>Rupiah:</strong> <span id="totalModalRp">Rp0</span></li>
  <li><strong>Dollar:</strong> <span id="totalModalUsd">$0</span></li>
</ul>

<table id="dataTable">
  <thead>
    <tr>
      <th>Admin</th>
      <th>Tanggal</th>
      <th>Modal (Rp)</th>
      <th>Modal (USD)</th>
      <th>Status</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody id="dataBody">
    <!-- Data akan di-render dengan JavaScript -->
  </tbody>
</table>

<script>
const role = "owner"; // Ubah ke "admin" untuk simulasi tampilan admin

const data = [
  {
    admin: "Sapani",
    tanggal: "2025-06-01",
    modalRp: 1000000,
    modalUsd: 100,
    status: "Belum ACC",
    peminjam: [
      { nama: "Budi", tanggal: "2025-06-01", jumlah: "Rp500000" },
      { nama: "Ani", tanggal: "2025-06-01", jumlah: "$50" }
    ]
  },
  {
    admin: "Wati",
    tanggal: "2025-06-02",
    modalRp: 2000000,
    modalUsd: 0,
    status: "ACC",
    peminjam: [
      { nama: "Joko", tanggal: "2025-06-02", jumlah: "Rp2000000" }
    ]
  },
  {
    admin: "Lisa",
    tanggal: "2025-06-03",
    modalRp: 0,
    modalUsd: 100,
    status: "ACC",
    peminjam: [
      { nama: "Andi", tanggal: "2025-06-03", jumlah: "$60" },
      { nama: "Rina", tanggal: "2025-06-03", jumlah: "$50" }
    ]
  }
];

function formatRupiah(number) {
  return "Rp" + number.toLocaleString("id-ID");
}

function formatDollar(number) {
  return "$" + number.toLocaleString("en-US", { minimumFractionDigits: 2 });
}

function parseCurrency(jumlah) {
  if (jumlah.includes("Rp")) {
    return { mataUang: "Rp", nilai: parseInt(jumlah.replace(/[^0-9]/g, '')) };
  } else if (jumlah.includes("$")) {
    return { mataUang: "$", nilai: parseFloat(jumlah.replace(/[^0-9.]/g, '')) };
  }
  return { mataUang: "", nilai: 0 };
}

// Fungsi untuk format string jumlah seperti "Rp500000" jadi "Rp500.000"
function formatCurrencyString(jumlah) {
  if (jumlah.includes("Rp")) {
    let angka = parseInt(jumlah.replace(/[^0-9]/g, ''));
    return "Rp" + angka.toLocaleString("id-ID");
  } else if (jumlah.includes("$")) {
    let angka = parseFloat(jumlah.replace(/[^0-9.]/g, ''));
    if (angka >= 1000) {
      return "$" + angka.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    } else {
      return "$" + angka.toFixed(2);
    }
  }
  return jumlah;
}

function isValidData(item) {
  let totalRp = 0;
  let totalUsd = 0;
  item.peminjam.forEach(p => {
    const parsed = parseCurrency(p.jumlah);
    if (parsed.mataUang === "Rp") {
      totalRp += parsed.nilai;
    } else if (parsed.mataUang === "$") {
      totalUsd += parsed.nilai;
    }
  });
  return totalRp === item.modalRp && totalUsd === item.modalUsd;
}

function renderTable() {
  const tbody = document.getElementById("dataBody");
  tbody.innerHTML = "";
  let totalRp = 0;
  let totalUsd = 0;

  data.forEach((item, index) => {
    if (!item.hidden) {
      const valid = isValidData(item);
      if (item.status !== "Ditolak") {
        totalRp += item.modalRp;
        totalUsd += item.modalUsd;
      }

      const tr = document.createElement("tr");
      if (!valid) tr.classList.add("row-error");

      tr.innerHTML = `
        <td>
          ${role === "owner" ? `<span class="owner-only" onclick="toggleDetail(${index})">${item.admin}</span>` : item.admin}
        </td>
        <td>${item.tanggal}</td>
        <td>${formatRupiah(item.modalRp)}</td>
        <td>${formatDollar(item.modalUsd)}</td>
        <td>${item.status}</td>
        <td>
          ${role === "owner" ? `
            <button class="btn btn-acc" onclick="setStatus(${index}, 'ACC')">ACC</button>
            <button class="btn btn-tolak" onclick="setStatus(${index}, 'Ditolak')">Tolak</button>
            <button class="btn btn-danger" onclick="hapusData(${index})">Hapus</button>
          ` : "-"}
        </td>
      `;
      tbody.appendChild(tr);

      const detailRow = document.createElement("tr");
      detailRow.className = "details";
      detailRow.id = `detail-${index}`;
      detailRow.style.display = "none"; // default hidden
      detailRow.innerHTML = `
        <td colspan="6">
          <strong>Daftar Peminjam:</strong><br>
          ${item.peminjam.map((p, i) => `Peminjam ${i+1}: ${p.nama}, Tanggal: ${p.tanggal}, Jumlah: ${formatCurrencyString(p.jumlah)}`).join("<br>")}
        </td>
      `;
      tbody.appendChild(detailRow);
    }
  });

  document.getElementById("totalModalRp").textContent = formatRupiah(totalRp);
  document.getElementById("totalModalUsd").textContent = formatDollar(totalUsd);
}

function toggleDetail(index) {
  const row = document.getElementById(`detail-${index}`);
  row.style.display = row.style.display === "table-row" ? "none" : "table-row";
}

function hapusData(index) {
  if (confirm("Yakin ingin menghapus data ini?")) {
    data[index].hidden = true;
    renderTable();
  }
}

function setStatus(index, status) {
  data[index].status = status;
  renderTable();
}

function applyFilters() {
  const adminFilter = document.getElementById("filterAdmin").value.toLowerCase();
  const dateFilter = document.getElementById("filterTanggal").value;
  const statusFilter = document.getElementById("filterStatus").value;

  data.forEach(item => {
    item.hidden = false;
    if (adminFilter && !item.admin.toLowerCase().includes(adminFilter)) item.hidden = true;
    if (dateFilter && item.tanggal !== dateFilter) item.hidden = true;
    if (statusFilter && item.status !== statusFilter) item.hidden = true;
  });

  renderTable();
}

renderTable();

</script>

</body>
</html>
